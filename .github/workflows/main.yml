name: Update Stats

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Count solutions by difficulty
        id: count
        run: |
          easy=0
          medium=0
          hard=0
          
          # Find all problem README files (in subdirectories, not root)
          for readme in */README.md; do
            [ -f "$readme" ] || continue
            
            # Extract difficulty from shields.io badge
            if grep -q "Difficulty-Easy" "$readme"; then
              easy=$((easy + 1))
            elif grep -q "Difficulty-Medium" "$readme"; then
              medium=$((medium + 1))
            elif grep -q "Difficulty-Hard" "$readme"; then
              hard=$((hard + 1))
            fi
          done
          
          total=$((easy + medium + hard))
          
          echo "easy=$easy" >> $GITHUB_OUTPUT
          echo "medium=$medium" >> $GITHUB_OUTPUT
          echo "hard=$hard" >> $GITHUB_OUTPUT
          echo "total=$total" >> $GITHUB_OUTPUT

      - name: Update README
        run: |
          easy=${{ steps.count.outputs.easy }}
          medium=${{ steps.count.outputs.medium }}
          hard=${{ steps.count.outputs.hard }}
          total=${{ steps.count.outputs.total }}
          
          # Create the new stats table
          cat > /tmp/stats.md << EOF
          | Difficulty | Solved |
          |------------|--------|
          | Easy       | $easy  |
          | Medium     | $medium |
          | Hard       | $hard  |
          | **Total**  | **$total** |
          EOF
          
          # Update README between markers using sed
          sed -i '/<!-- STATS:START -->/,/<!-- STATS:END -->/{ 
            /<!-- STATS:START -->/{ 
              p
              r /tmp/stats.md
            }
            /<!-- STATS:END -->/p
            d
          }' README.md

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ“Š Update stats"
          git push
